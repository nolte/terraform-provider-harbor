# Development

## Visual Studio Code DevContainer

For Easy development use [Visual Studio Code DevContainer](https://code.visualstudio.com/docs/remote/containers), you can find the basement from the Development Containers at [nolte/vscode-devcontainers](https://github.com/nolte/vscode-devcontainers).

### Precondition for Use

* Create you Github Personal Access Token under [github.com/settings/tokens](https://github.com/settings/tokens) with the following scopes:
    * `read:packages`

* Login to fetch the required dev containers

```sh
    docker login docker.pkg.github.com
```

* Grab you a Coffee and wait for 3 Minutes (This happens on the first time use)
* Click Terminal -> New Terminal and execute the following command:

```sh
    make
```

## Process

| *branch*            | *description*                                                                                                           |
|---------------------|-------------------------------------------------------------------------------------------------------------------------|
| ```master```        | The ```master``` will only used for Presentation, and the Deployment process.                                           |
| ```tags/v*```       | All Created Releases must be start with a `v*` prefix at the tag name.                                                  |
| ```gh-pages```      | Branch for the Static HTML presentation, generated by the GitHub Release Workflow.                                      |
| ```develop```       | Branch for the current development, this branch will be used for integrate new Features, and starting the release flow. |
| ```feature/*```     | This are temporary branches for develop new functions.                                                                  |
| ```fix/*```         | Used for bugfixing from existing versions, if no FastForward Fix Possible.                                              |

Please use the ```develop``` branch for new features and fixes.

### Releasing

The [Github Release](https://github.com/nolte/terraform-provider-harbor/releases) Assets will be automatic attach from the build job see ```.github/workflows/gorelease.yaml```. The Release Process use [goreleaser](https://goreleaser.com/) for create the the Binaries.
Each Release will be start, *at the moment*, from the ```develop``` branch.
The release description will be generated by [release-drafter/release-drafter](https://github.com/release-drafter/release-drafter) in a seperated workflow. Look to ``.github/workflows/release-drafter.yml`` for the Job, and ``.github/release-drafter.yml`` for the description configuration.

## Build

The Build scripted at the moment splitted into the GitHub Workflow Stuff and a combination of Makefiles and Shell Scripts, an Targets from the [nolte/plumbing](https://github.com/nolte/plumbing).
The ``Makefile/Magefile`` should be use for the local development, permanten using the full GitHub Workflows needs a lot of time.

You will get the compleat list of possible [Magefile](https://magefile.org/magefiles/) Targets with:

```sh
cd ./tools && go run mage.go -l
```

### CI/CD

For local usage the GitHub Actions we use the [nektos/act](https://github.com/nektos/act) Project.
The first local execute will be take some time for pulling the large [nektos/act-environments-ubuntu:18.04](https://hub.docker.com/r/nektos/act-environments-ubuntu/tags) image.

| *Workflow Job*                                                                                                                                                                                                                          | *Job*                                        | *Local* | *Description*                                                                                                      |
|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------|---------|--------------------------------------------------------------------------------------------------------------------|
| [![Classic CI/CD](https://github.com/nolte/terraform-provider-harbor/workflows/Classic%20CI/CD/badge.svg)](https://github.com/nolte/terraform-provider-harbor/actions?query=workflow%3A%22Classic+CI%2FCD%22)                           | `build`                                      | üëç       | This is the Classic Build job with Static Tests, and compile the provider.                                         |
| [![Release Flow](https://github.com/nolte/terraform-provider-harbor/workflows/Release%20Flow/badge.svg)](https://github.com/nolte/terraform-provider-harbor/actions?query=workflow%3A%22Release+Flow%22)                                | `releaseBuild`                               | üëé       | This Job are used for attatch Release Assets to a existing GHRelease                                               |
| [![Acception Tests CI/CD](https://github.com/nolte/terraform-provider-harbor/workflows/Acception%20Tests%20CI/CD/badge.svg)](https://github.com/nolte/terraform-provider-harbor/actions?query=workflow%3A%22Acception+Tests+CI%2FCD%22) | `acc`                                        | üëé       | Starting a full run of Terraform Integration Tests, with starting a local kind cluster and deploy a `v2` Harbor.   |
| [![shellcheck](https://github.com/nolte/terraform-provider-harbor/workflows/shellcheck/badge.svg)](https://github.com/nolte/terraform-provider-harbor/actions?query=workflow%3Ashellcheck)                                              | `shellcheck-check`                           | üëç       | Check the Schell scripts for problems.                                                                             |
| [![devcontainers](https://github.com/nolte/terraform-provider-harbor/workflows/devcontainers/badge.svg)](https://github.com/nolte/terraform-provider-harbor/actions?query=workflow%3Adevcontainers)                                     | `devcontainers-check`,`docscontainers-check` | üëé       | Simple build job for the both Dev Containers (VSCode and mkdocs)                                                   |

```bash
# call job
act -j <job> -P ubuntu-latest=nektos/act-environments-ubuntu:18.04

# example calling the build workflow
act -j build -P ubuntu-latest=nektos/act-environments-ubuntu:18.04
```

Since the Acception Tests Workflow is a matrix build, for better Tests again different Harbor Versions. It is not possible to run it locally, because the you can`t start two or more Kind Cluster out of the box locally. Feature Request [#114](https://github.com/nektos/act/issues/114) for call a specific Matrix Workflow.


### HarborAPI Client

At the moment the Swagger Json for generate the Api Client, look [./docs/adr/0001-use-swagger-for-generate-http-client.md](https://github.com/nolte/terraform-provider-harbor/blob/develop/docs/adr/0001-use-swagger-for-generate-http-client.md).

For manipulate the Swagger Json, and generating a useable go api client, we use [evanphx/json-patch](https://github.com/evanphx/json-patch) inside the buildprocess, for adding or replace different JSonStructures. So if you need new manipulations, change the `scripts/swagger-specs/patch.1.json` patch file. More informations about [jsonpatch](http://jsonpatch.com/). The problem are tracked, [#12474](https://github.com/goharbor/harbor/issues/12474).

## Docs

The Documentation are presented in Different Formats, as [GitHub Page](https://nolte.github.io/terraform-provider-harbor/) , and for the [registry.terraform.io](https://registry.terraform.io/providers/nolte/harbor/latest/docs).


### GitHub Page

If you use the [VSCode DevContainer](#visual-studio-code-devcontainer), the [mkdocs](https://www.mkdocs.org/) container will be started automatical, as a sidecar container.
At the Development you ca access the current state from the Documentation at [127.0.0.1:8000](http://127.0.0.1:8000/).
For some extras, like Tasks List or Snippeds we use the [MarkdownPP](https://github.com/jreese/markdown-pp) project.


### Terraform Registry

The Focus from the Registy Documentation is the Provider self, for example `Resources` and `Datasources`. More informations about the Required Format at [terraform.io](https://www.terraform.io/docs/registry/providers/docs.html).


## Development Shortcuts

**build and test in one command**

```sh
make compile \
    && make install \
    && bats scripts/test/bats/build
```

```
terraform import -var harbor_endpoint=${HARBOR_ENDPOINT} -var harbor_base_path='/api' harbor_project.main 24
```

## Links

* [writing-custom-providers](https://www.terraform.io/docs/extend/writing-custom-providers.html)
